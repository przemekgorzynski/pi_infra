---
- name: create admin group
  group:
    name: admins
    state: present
  tags:
    - user_config

- name: Create users
  ansible.builtin.user:
    name: "{{ item.name }}"
    password: "{{ item.password }}"
    state: present
    shell:  "{{ item.shell }}"
    groups: "{{ item.groups }}"
    create_home: yes
  no_log: True
  loop:
    - { name: 'przemek', password: "{{ przemek_pass }}", groups: 'sudo,admins', shell: '/bin/bash' }
    - { name: 'ro', password: 'ro', groups: 'users', shell: '/bin/bash' }
  tags:
    - user_config

- name: Update authorized keys
  authorized_key:
    user: "{{ item }}"
    state: present
    key: "{{ lookup('file', '../files/id_rsa_przemek.pub') }}"
  with_items:
    - przemek
    - pi
  tags:
    - user_config

- name: Allow sudo for admins group
  copy:
    content: "%admins ALL=(ALL) NOPASSWD:ALL"
    dest: /etc/sudoers.d/admins
    mode: 0600
  tags:
    - user_config